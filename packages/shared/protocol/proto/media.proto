syntax = "proto3";

package graphwiz.media;

import "core.proto";

// SFU media service for audio/video streaming
service MediaService {
  // WebRTC signaling
  rpc CreateOffer (CreateOfferRequest) returns (CreateOfferResponse);
  rpc CreateAnswer (CreateAnswerRequest) returns (CreateAnswerResponse);
  rpc SetRemoteDescription (SetRemoteDescriptionRequest) returns (SetRemoteDescriptionResponse);
  rpc AddIceCandidate (AddIceCandidateRequest) returns (AddIceCandidateResponse);

  // Media track management
  rpc AddTrack (AddTrackRequest) returns (AddTrackResponse);
  rpc RemoveTrack (RemoveTrackRequest) returns (RemoveTrackResponse);
  rpc MuteTrack (MuteTrackRequest) returns (MuteTrackResponse);

  // Session management
  rpc JoinSession (JoinSessionRequest) returns (JoinSessionResponse);
  rpc LeaveSession (LeaveSessionRequest) returns (LeaveSessionResponse);

  // Server-side streaming for media events
  rpc StreamMediaEvents (StreamMediaEventsRequest) returns (stream MediaEvent);
}

// WebRTC SDP offer
message CreateOfferRequest {
  string room_id = 1;
  string client_id = 2;
  MediaConstraints constraints = 3;
}

message CreateOfferResponse {
  bool success = 1;
  string sdp = 2;
  string session_id = 3;
}

// WebRTC SDP answer
message CreateAnswerRequest {
  string room_id = 1;
  string client_id = 2;
  string offer_sdp = 3;
  MediaConstraints constraints = 4;
}

message CreateAnswerResponse {
  bool success = 1;
  string sdp = 2;
}

// Remote description
message SetRemoteDescriptionRequest {
  string room_id = 1;
  string client_id = 2;
  string sdp = 3;
  SessionDescriptionType type = 4;
}

message SetRemoteDescriptionResponse {
  bool success = 1;
}

// ICE candidates
message AddIceCandidateRequest {
  string room_id = 1;
  string client_id = 2;
  IceCandidate candidate = 3;
}

message AddIceCandidateResponse {
  bool success = 1;
}

message IceCandidate {
  string candidate = 1;
  string sdp_mid = 2;
  int32 sdp_mline_index = 3;
  string username_fragment = 4;
}

// Track management
message AddTrackRequest {
  string room_id = 1;
  string client_id = 2;
  string track_id = 3;
  TrackKind kind = 4;
  map<string, string> metadata = 5;
}

message AddTrackResponse {
  bool success = 1;
  string track_id = 2;
  string transceiver_id = 3;
}

message RemoveTrackRequest {
  string room_id = 1;
  string client_id = 2;
  string track_id = 3;
}

message RemoveTrackResponse {
  bool success = 1;
}

message MuteTrackRequest {
  string room_id = 1;
  string client_id = 2;
  string track_id = 3;
  bool muted = 4;
}

message MuteTrackResponse {
  bool success = 1;
}

// Session management
message JoinSessionRequest {
  string room_id = 1;
  string client_id = 2;
  string display_name = 3;
  bool publish_audio = 4;
  bool publish_video = 5;
}

message JoinSessionResponse {
  bool success = 1;
  string session_id = 2;
  repeated ActiveTrack existing_tracks = 3;
  repeated string participant_ids = 4;
}

message LeaveSessionRequest {
  string room_id = 1;
  string client_id = 2;
  string session_id = 3;
}

message LeaveSessionResponse {
  bool success = 1;
}

// Media event streaming
message StreamMediaEventsRequest {
  string room_id = 1;
  string client_id = 2;
}

message MediaEvent {
  string event_id = 1;
  int64 timestamp = 2;
  oneof payload {
    TrackPublished track_published = 10;
    TrackUnpublished track_unpublished = 11;
    TrackUpdated track_updated = 12;
    ParticipantJoined participant_joined = 20;
    ParticipantLeft participant_left = 21;
    ParticipantUpdated participant_updated = 22;
    SdpOffer sdp_offer = 30;
    SdpAnswer sdp_answer = 31;
    IceCandidate ice_candidate = 32;
  }
}

message TrackPublished {
  string track_id = 1;
  string client_id = 2;
  TrackKind kind = 3;
  map<string, string> metadata = 4;
}

message TrackUnpublished {
  string track_id = 1;
  string client_id = 2;
}

message TrackUpdated {
  string track_id = 1;
  bool muted = 2;
  map<string, string> metadata = 3;
}

message ParticipantJoined {
  string client_id = 1;
  string display_name = 2;
  repeated string track_ids = 3;
}

message ParticipantLeft {
  string client_id = 1;
}

message ParticipantUpdated {
  string client_id = 1;
  map<string, bool> muted_tracks = 2;
}

message SdpOffer {
  string client_id = 1;
  string sdp = 2;
}

message SdpAnswer {
  string client_id = 1;
  string sdp = 2;
}

message ActiveTrack {
  string track_id = 1;
  string client_id = 2;
  TrackKind kind = 3;
  bool muted = 4;
  map<string, string> metadata = 5;
}

// Media types and constraints
enum TrackKind {
  AUDIO = 0;
  VIDEO = 1;
  DATA = 2;
}

enum SessionDescriptionType {
  OFFER = 0;
  ANSWER = 1;
  PRANSWER = 2;
  ROLLBACK = 3;
}

message MediaConstraints {
  bool audio = 1;
  bool video = 2;
  bool data = 3;
  AudioConstraints audio_constraints = 4;
  VideoConstraints video_constraints = 5;
}

message AudioConstraints {
  bool echo_cancellation = 1;
  bool noise_suppression = 2;
  bool auto_gain_control = 3;
  int32 sample_rate = 4;
  int32 channel_count = 5;
}

message VideoConstraints {
  int32 max_width = 1;
  int32 max_height = 2;
  int32 max_frame_rate = 3;
  VideoCodecType preferred_codec = 4;
}

enum VideoCodecType {
  VP8 = 0;
  VP9 = 1;
  H264 = 2;
  AV1 = 3;
}
