name: Docker CI

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/deploy/**'
      - 'packages/services/**'
      - 'packages/clients/**'
  push:
    branches: [main, develop]
    paths:
      - 'packages/deploy/**'
      - 'packages/services/**'
      - 'packages/clients/**'

jobs:
  build-services:
    name: Build Service Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - auth
          - hub
          - presence
          - sfu
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }}
        run: |
          docker build -f packages/deploy/docker/Dockerfile.${{ matrix.service }} \
            -t graphwiz-xr/${{ matrix.service }}:latest .

  build-clients:
    name: Build Client Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        client:
          - hub-client
          - admin-client
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.client }}
        run: |
          docker build -f packages/deploy/docker/Dockerfile.${{ matrix.client }} \
            -t graphwiz-xr/${{ matrix.client }}:latest .

  test-compose:
    name: Test Docker Compose
    runs-on: ubuntu-latest
    needs: [build-services, build-clients]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build compose images
        run: |
          cd packages/deploy/compose
          docker compose build

      - name: Start services
        run: |
          cd packages/deploy/compose
          docker compose up -d

      - name: Check service health
        run: |
          sleep 10
          cd packages/deploy/compose
          docker compose ps

      - name: View logs
        if: always()
        run: |
          cd packages/deploy/compose
          docker compose logs
