# GraphWiz-XR Docker Compose with Traefik Reverse Proxy
#
# Domain: xr.graphwiz.ai
# Services run behind Traefik for automatic SSL/TLS and routing
#
# Prerequisites:
#   1. Copy .env.example to .env and configure
#   2. Set up Cloudflare API token in environment
#   3. Run: docker-compose up -d
#
# Usage:
#   docker-compose up -d                # Start all services
#   docker-compose logs -f traefik      # View Traefik logs
#   docker-compose ps                   # Check service status
#   docker-compose down                 # Stop all services

version: '3.9'

services:
  # ============================================================================
  # TRAEFIK REVERSE PROXY
  # ============================================================================
  traefik:
    image: traefik:v2.10
    container_name: graphwiz-traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - '80:80' # HTTP
      - '443:443' # HTTPS
      - '127.0.0.1:8080:8080' # Dashboard (local only)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - traefik-letsencrypt:/letsencrypt
      - traefik-logs:/var/log/traefik
    environment:
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
      - TRAEFIK_DOMAIN=${TRAEFIK_DOMAIN:-xr.graphwiz.ai}
    networks:
      - traefik-public
      - graphwiz-internal
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.dashboard.rule=Host(`traefik.xr.graphwiz.ai`) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))'
      - 'traefik.http.routers.dashboard.service=api@internal'
      - 'traefik.http.routers.dashboard.middlewares=admin-auth'
      - 'traefik.http.routers.dashboard.tls.certresolver=letsencrypt'

  # ============================================================================
  # POSTGRESQL DATABASE
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: graphwiz-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DATABASE_USER:-graphwiz}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-graphwiz_dev}
      POSTGRES_DB: ${DATABASE_NAME:-graphwiz}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./packages/deploy/compose/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DATABASE_USER:-graphwiz}']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - graphwiz-internal
    labels:
      - 'traefik.enable=false' # Database not exposed externally

  # ============================================================================
  # REDIS CACHE
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: graphwiz-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_dev}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - graphwiz-internal
    labels:
      - 'traefik.enable=false' # Redis not exposed externally

  # ============================================================================
  # AUTH SERVICE
  # ============================================================================
  auth:
    build:
      context: .
      dockerfile: packages/deploy/docker/Dockerfile.auth
    container_name: graphwiz-auth
    restart: unless-stopped
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      DATABASE_URL: postgresql://${DATABASE_USER:-graphwiz}:${DATABASE_PASSWORD:-graphwiz_dev}@postgres:5432/${DATABASE_NAME:-graphwiz}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_dev}@redis:6379
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8001
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - traefik-public
      - graphwiz-internal
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.auth.rule=Host(`xr.graphwiz.ai`) && PathPrefix(`/api/auth`, `/api/v1/auth`)'
      - 'traefik.http.routers.auth.entrypoints=websecure'
      - 'traefik.http.services.auth.loadbalancer.server.port=8001'
      - 'traefik.http.routers.auth.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.auth.middlewares=security-headers,cors,rate-limit,api-strip'
      - 'traefik.http.middlewares.auth-stripprefix.stripprefix.prefixes=/api/v1'

  # ============================================================================
  # HUB SERVICE (Room/Entity Management)
  # ============================================================================
  hub:
    build:
      context: .
      dockerfile: packages/deploy/docker/Dockerfile.hub
    container_name: graphwiz-hub
    restart: unless-stopped
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      DATABASE_URL: postgresql://${DATABASE_USER:-graphwiz}:${DATABASE_PASSWORD:-graphwiz_dev}@postgres:5432/${DATABASE_NAME:-graphwiz}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_dev}@redis:6379
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8002
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth:
        condition: service_started
    networks:
      - traefik-public
      - graphwiz-internal
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.hub.rule=Host(`xr.graphwiz.ai`) && PathPrefix(`/api/hub`, `/api/v1/hub`)'
      - 'traefik.http.routers.hub.entrypoints=websecure'
      - 'traefik.http.services.hub.loadbalancer.server.port=8002'
      - 'traefik.http.routers.hub.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.hub.middlewares=security-headers,cors,rate-limit,api-strip'

  # ============================================================================
  # PRESENCE SERVICE (WebRTC Signaling/WebTransport)
  # ============================================================================
  presence:
    build:
      context: .
      dockerfile: packages/deploy/docker/Dockerfile.presence
    container_name: graphwiz-presence
    restart: unless-stopped
    ports:
      - '4000:4000' # Expose WebSocket for local development (container 8003 -> host 4003)
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      DATABASE_URL: postgresql://${DATABASE_USER:-graphwiz}:${DATABASE_PASSWORD:-graphwiz_dev}@postgres:5432/${DATABASE_NAME:-graphwiz}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_dev}@redis:6379
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8003
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      # auth:  # Temporarily disabled - auth service not built yet
      #   condition: service_started
    networks:
      - traefik-public
      - graphwiz-internal
    labels:
      - 'traefik.enable=true'
      # Service definition FIRST
      - 'traefik.http.services.presence.loadbalancer.server.port=8003'
      # Then router
      - 'traefik.http.routers.presence.rule=Host(`xr.graphwiz.ai`) && PathPrefix(`/ws`)'
      - 'traefik.http.routers.presence.entrypoints=websecure'
      - 'traefik.http.routers.presence.priority=100'
      - 'traefik.http.routers.presence.tls.certresolver=letsencrypt'

  # ============================================================================
  # AVATAR SERVICE (Avatar Configuration)
  # ============================================================================
  avatar:
    build:
      context: .
      dockerfile: packages/deploy/docker/Dockerfile.avatar
    container_name: graphwiz-avatar
    restart: unless-stopped
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      DATABASE_URL: postgresql://${DATABASE_USER:-graphwiz}:${DATABASE_PASSWORD:-graphwiz_dev}@postgres:5432/${DATABASE_NAME:-graphwiz}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_dev}@redis:6379
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8005
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - traefik-public
      - graphwiz-internal
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.services.avatar.loadbalancer.server.port=8005'
      - 'traefik.http.routers.avatar.rule=Host(`xr.graphwiz.ai`) && PathPrefix(`/api/avatar`)'
      - 'traefik.http.routers.avatar.entrypoints=websecure'
      - 'traefik.http.routers.avatar.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.avatar.middlewares=security-headers,cors,avatar-strip'
      - 'traefik.http.middlewares.avatar-strip.stripprefix.prefixes=/api/avatar'

  # SFU SERVICE (WebRTC Media Forwarding)
  # ============================================================================
  sfu:
    build:
      context: .
      dockerfile: packages/deploy/docker/Dockerfile.sfu
    container_name: graphwiz-sfu
    restart: unless-stopped
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      DATABASE_URL: postgresql://${DATABASE_USER:-graphwiz}:${DATABASE_PASSWORD:-graphwiz_dev}@postgres:5432/${DATABASE_NAME:-graphwiz}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_dev}@redis:6379
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8004
      SFU_MAX_ROOMS: ${SFU_MAX_ROOMS:-100}
      SFU_MAX_PEERS_PER_ROOM: ${SFU_MAX_PEERS_PER_ROOM:-50}
      SFU_RTP_PORT_START: ${SFU_RTP_PORT_START:-10000}
      SFU_RTP_PORT_END: ${SFU_RTP_PORT_END:-20000}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      presence:
        condition: service_started
    networks:
      - traefik-public
      - graphwiz-internal
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.sfu.rule=Host(`xr.graphwiz.ai`) && PathPrefix(`/api/sfu`)'
      - 'traefik.http.routers.sfu.entrypoints=websecure'
      - 'traefik.http.services.sfu.loadbalancer.server.port=8004'
      - 'traefik.http.routers.sfu.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.sfu.middlewares=security-headers,cors,api-strip'
    ports:
      - '10000-10100:10000-10100/udp' # RTP ports for WebRTC

  # ============================================================================
  # HUB CLIENT (Frontend Application)
  # ============================================================================
  hub-client:
    build:
      context: .
      dockerfile: packages/deploy/docker/Dockerfile.hub-client
      target: development
    container_name: graphwiz-hub-client
    restart: unless-stopped
    ports:
      - '5173:5173'
    networks:
      - graphwiz-internal
    environment:
      - VITE_API_BASE_URL=http://localhost:8000/api/v1/auth
      - VITE_HUB_API_URL=http://localhost:8002/api/v1/hub
      - VITE_PRESENCE_WS_URL=ws://localhost:4000
      - VITE_SFU_URL=http://localhost:8004/api/v1/sfu
      - VITE_ROOM_ID=lobby
  # ============================================================================
  # ADMIN CLIENT (Optional - for dashboard/admin panel)
  # ============================================================================
  admin-client:
    build:
      context: .
      dockerfile: packages/deploy/docker/Dockerfile.admin-client
      target: production
    container_name: graphwiz-admin-client
    restart: unless-stopped
    environment:
      VITE_API_BASE_URL: https://xr.graphwiz.ai/api
    networks:
      - traefik-public
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.admin.rule=Host(`admin.xr.graphwiz.ai`)'
      - 'traefik.http.routers.admin.entrypoints=websecure'
      - 'traefik.http.services.admin.loadbalancer.server.port=80'
      - 'traefik.http.routers.admin.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.admin.middlewares=security-headers,compression,admin-auth'

  # ============================================================================
  # ADMINER (Database Management UI - Internal Only)
  # ============================================================================
  adminer:
    image: adminer:latest
    container_name: graphwiz-adminer
    restart: unless-stopped
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    networks:
      - graphwiz-internal
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.adminer.rule=Host(`adminer.xr.graphwiz.ai`)'
      - 'traefik.http.routers.adminer.entrypoints=websecure'
      - 'traefik.http.services.adminer.loadbalancer.server.port=8080'
      - 'traefik.http.routers.adminer.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.adminer.middlewares=admin-auth'
      # Only allow from specific IPs (uncomment and configure)
      # - "traefik.http.routers.adminer.middlewares=ip-whitelist"

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  traefik-letsencrypt:
    driver: local
  traefik-logs:
    driver: local

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  traefik-public:
    external: true
  graphwiz-internal:
    driver: bridge
